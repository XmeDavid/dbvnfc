services:
  postgres:
    image: postgres:16
    container_name: pointfinder-db
    environment:
      POSTGRES_DB: pointfinder
      POSTGRES_USER: scout
      POSTGRES_PASSWORD: scout
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scout -d pointfinder"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pointfinder-api
    expose:
      - "8080"
    environment:
      JAVA_OPTS: "-Xms256m -Xmx1200m"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/pointfinder?stringtype=unspecified
      SPRING_DATASOURCE_USERNAME: scout
      SPRING_DATASOURCE_PASSWORD: scout
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET must be set in .env or environment}
      CORS_ORIGINS: http://localhost,https://pointfinder.pt,https://pointfinder.ch
      # APNs (Apple Push Notifications) configuration - values come from .env
      # Single source of truth: APPLE_PROD_APNS_KEY is both the Key ID and part of the filename
      APNS_ENABLED: ${APNS_ENABLED:-false}
      # Use file: URL so Spring's ResourceLoader reads from filesystem, not classpath
      APNS_KEY_PATH: ${APNS_KEY_PATH:-file:/app/config/apns-key.p8}
      APNS_KEY_ID: ${APPLE_PROD_APNS_KEY:-}      # e.g. G9D86M2578
      APNS_TEAM_ID: ${APNS_TEAM_ID:-}            # e.g. ABC123DEFG
      APNS_BUNDLE_ID: ${APNS_BUNDLE_ID:-com.prayer.pointfinder}
      APNS_PRODUCTION: ${APNS_PRODUCTION:-false}
      # FCM (Firebase Cloud Messaging) configuration - values come from .env
      FCM_ENABLED: ${FCM_ENABLED:-false}
      # Use file: URL so Spring's ResourceLoader reads from filesystem, not classpath
      FCM_CREDENTIALS_PATH: ${FCM_CREDENTIALS_PATH:-file:/app/config/firebase-service-account.json}
      FCM_PROJECT_ID: ${FCM_PROJECT_ID:-}
      MAIL_HOST: smtp.resend.com
      MAIL_USERNAME: resend
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM: info@pointfinder.pt
      MAIL_ENABLED: ${MAIL_ENABLED:-false}
      FRONTEND_URL: https://pointfinder.pt
      APP_UPLOADS_PATH: /uploads
      APP_UPLOADS_MAX_FILE_SIZE_BYTES: ${APP_UPLOADS_MAX_FILE_SIZE_BYTES:-2147483648}
      APP_UPLOADS_CHUNK_ENABLED: ${APP_UPLOADS_CHUNK_ENABLED:-true}
      APP_UPLOADS_CHUNK_DEFAULT_SIZE_BYTES: ${APP_UPLOADS_CHUNK_DEFAULT_SIZE_BYTES:-8388608}
      APP_UPLOADS_CHUNK_MAX_SIZE_BYTES: ${APP_UPLOADS_CHUNK_MAX_SIZE_BYTES:-16777216}
      APP_UPLOADS_CHUNK_SESSION_TTL_SECONDS: ${APP_UPLOADS_CHUNK_SESSION_TTL_SECONDS:-172800}
      APP_UPLOADS_MAX_ACTIVE_SESSIONS_PER_PLAYER: ${APP_UPLOADS_MAX_ACTIVE_SESSIONS_PER_PLAYER:-3}
      APP_UPLOADS_MAX_ACTIVE_BYTES_PER_GAME: ${APP_UPLOADS_MAX_ACTIVE_BYTES_PER_GAME:-17179869184}
    volumes:
      - ${UPLOADS_PATH:-./data/uploads}:/uploads
      # Mount your APNs .p8 key from the host into the container (read-only)
      # The filename includes the Key ID from APPLE_PROD_APNS_KEY (e.g. AuthKey_G9D86M2578.p8)
      - ./secrets/AuthKey_${APPLE_PROD_APNS_KEY}.p8:/app/config/apns-key.p8:ro
      # Mount your Firebase service account JSON from the host into the container (read-only)
      - ./secrets/firebase-service-account.json:/app/config/firebase-service-account.json:ro
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build:
      context: ./web-admin
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /api
        VITE_WS_URL: /ws
    container_name: pointfinder-web
    volumes:
      - frontend_dist:/app/dist
    healthcheck:
      test: ["CMD", "test", "-f", "/app/dist/index.html"]
      interval: 2s
      timeout: 2s
      retries: 30

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: pointfinder-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ${UPLOADS_PATH:-./data/uploads}:/uploads:ro
      - frontend_dist:/usr/share/nginx/html/app:ro
    depends_on:
      backend:
        condition: service_started
      frontend:
        condition: service_healthy
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"

  certbot:
    image: certbot/certbot
    container_name: pointfinder-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  pgdata:
  frontend_dist:
